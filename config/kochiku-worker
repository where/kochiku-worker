#!/bin/bash --login
WORKER_DIR=/app/kochiku-worker/current
PIDFILE=/app/kochiku-worker/shared/pids/kochiku-worker.pid
QUEUES=ci,developer

cd $WORKER_DIR

case "$1" in
  start)
    start-stop-daemon --start \
      --quiet \
      --background \
      --pidfile "$PIDFILE"
      --chuid stack:stack
      --chdir "$WORKER_DIR" \
      --exec "QUEUES='${queues}' VERBOSE=1 bundle exec rake resque:work"
    # rm -f $PIDFILE
    # su -l stack -c 'cd '$WORKER_DIR' && QUEUES='${queues}' VERBOSE=1 bundle exec rake resque:work </dev/null & >> '$WORKER_DIR'/log/resque.log 2>&1 &'
    # touch
  ;;
  stop)
    start-stop-daemon --stop \
     --quiet \
     --pidfile "$PIDFILE" \
     --name "ruby" \
     --signal QUIT \
     --chdir "WORKER_DIR" \
     --retry 4
  ;;
  restart)
    $0 stop
    $0 start
  ;;
  *)
    echo "Usage: $0 {start|stop|restart|pause|cont|status}"
    exit 1
esac

